<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TinyCore Online Repo</title>
  <link href="https://fonts.cdnfonts.com/css/liberation-mono" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Liberation Mono', monospace;
      background-color: #f0f4f8;
      color: #333;
      padding: 1rem;
    }

    header {
      text-align: center;
      margin-bottom: 1rem;
    }

    h1 {
      margin-bottom: 0.5rem;
      font-size: 1.6rem;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    select, input {
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 5px;
      min-width: 140px;
      font-size: 1rem;
    }

    #StatusInfo {
      font-size: 0.9rem;
      color: #666;
      text-align: center;
      margin-top: 0.5rem;
    }

    main {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      max-width: 1000px;
      margin: 0 auto;
    }

    .list-container {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    #TCZList {
      width: 100%;
      height: 200px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    #InfoList {
      display: none;
      white-space: pre-wrap;
      padding: 1rem;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 5px;
      overflow-x: auto;
    }

    @media (min-width: 600px) {
      .list-container {
        flex-direction: row;
      }

      #TCZList {
        width: 30%;
        height: 400px;
      }

      #InfoList {
        width: 70%;
      }
    }

    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-thumb {
      background-color: #888;
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <header>
    <h1>TinyCore Online Repo</h1>
    <div class="controls">
      <select id="SelectVersion" hidden></select>
      <select id="SearchType" hidden>
        <option>Search</option>
        <option disabled>Provides</option>
        <option disabled>Tags</option>
        <option disabled>Src</option>
        <option>Info</option>
      </select>
      <input id="InputSearchTerm" type="text" hidden placeholder="Search term..." />
    </div>
    <p id="StatusInfo">Loading versions...</p>
  </header>

  <main>
    <div class="list-container">
      <select id="TCZList" size="10"></select>
      <div id="InfoList"></div>
    </div>
  </main>

  <script>
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => document.querySelectorAll(selector);

    let selectedVersion = '';
    let selectedArch = '';

    async function fetchText(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Failed to fetch ${url}`);
      return res.text();
    }

    async function loadVersions() {
      const raw = await fetchText('https://raw.githubusercontent.com/CardealRusso/tinycore-online-repo/main/site-data/versions');
      const jsonString = raw.replace(/,\s*([\]}])/g, '$1');
      const versions = JSON.parse(jsonString);

      const select = $('#SelectVersion');
      Object.keys(versions).sort((a, b) => parseInt(b) - parseInt(a)).forEach(version => {
        const group = document.createElement('optgroup');
        group.label = version;
        versions[version].forEach(arch => {
          const opt = document.createElement('option');
          opt.value = arch;
          opt.textContent = arch;
          group.appendChild(opt);
        });
        select.appendChild(group);
      });

      select.hidden = false;
      $('#SearchType').hidden = false;
      $('#InputSearchTerm').hidden = false;
      $('#StatusInfo').textContent = '';
    }

    async function loadTczList() {
      $('#StatusInfo').textContent = `Loading list for ${selectedVersion}/${selectedArch}...`;
      const data = await fetchText(`https://raw.githubusercontent.com/CardealRusso/tinycore-online-repo/main/data/${selectedVersion}/${selectedArch}/tczlist`);
      const list = $('#TCZList');
      list.innerHTML = '';

      data.trim().split('\n').forEach(item => {
        const opt = document.createElement('option');
        opt.textContent = item;
        list.appendChild(opt);
      });

      $('#StatusInfo').textContent = '';
    }

    async function loadInfoFile(name) {
      $('#StatusInfo').textContent = `Loading ${name}.info...`;
      const info = await fetchText(`https://raw.githubusercontent.com/CardealRusso/tinycore-online-repo/main/tinycorelinux/${selectedVersion}/${selectedArch}/tcz/${name}.info`);
      const infoList = $('#InfoList');
      infoList.innerHTML = info;
      infoList.style.display = 'block';
      $('#StatusInfo').textContent = '';
    }

    async function deepSearch(term) {
      $('#StatusInfo').textContent = `Searching in .info files...`;
      const data = await fetchText(`https://raw.githubusercontent.com/CardealRusso/tinycore-online-repo/main/data/${selectedVersion}/${selectedArch}/tczlist`);
      const list = $('#TCZList');
      list.innerHTML = '';
      const items = data.trim().split('\n');
      let count = 0;

      for (const name of items) {
        count++;
        $('#StatusInfo').textContent = `${count}/${items.length}: ${name}.info`;
        try {
          const info = await fetchText(`https://raw.githubusercontent.com/CardealRusso/tinycore-online-repo/main/tinycorelinux/${selectedVersion}/${selectedArch}/tcz/${name}.info`);
          if (info.toLowerCase().includes(term.toLowerCase())) {
            const opt = document.createElement('option');
            opt.textContent = name;
            list.appendChild(opt);
          }
        } catch (err) {
          continue;
        }
      }

      $('#StatusInfo').textContent = '';
    }

    function setupEvents() {
      $('#SelectVersion').addEventListener('change', async (e) => {
        const selectedOpt = e.target.selectedOptions[0];
        selectedVersion = selectedOpt.parentElement.label;
        selectedArch = selectedOpt.value;
        await loadTczList();
      });

      $('#TCZList').addEventListener('change', async (e) => {
        const name = e.target.value;
        if (name) await loadInfoFile(name);
      });

      $('#InputSearchTerm').addEventListener('keypress', async (e) => {
        if (e.key === 'Enter' && selectedVersion) {
          const term = $('#InputSearchTerm').value.trim();
          const type = $('#SearchType').value.toLowerCase();
          const list = $('#TCZList');

          if (type === 'search') {
            const options = [...list.options];
            options.forEach(opt => {
              opt.style.display = opt.textContent.toLowerCase().includes(term.toLowerCase()) ? '' : 'none';
            });
          }

          if (type === 'info') {
            list.innerHTML = '';
            await deepSearch(term);
          }
        }
      });
    }

    document.addEventListener('DOMContentLoaded', async () => {
      setupEvents();
      await loadVersions();
    });
  </script>
</body>
</html>
